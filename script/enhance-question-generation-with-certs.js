#!/usr/bin/env node
/**
 * Enhance Question Generation with Certification Awareness
 * 
 * This script updates the question generation logic to automatically
 * consider certifications when generating questions for channels.
 * 
 * When generating questions for a channel (e.g., 'aws', 'kubernetes'),
 * it will also generate certification-specific MCQ questions for
 * related certifications.
 */

import fs from 'fs';
import path from 'path';

console.log('üîß Enhancing Question Generation with Certification Awareness\n');
console.log('‚ïê'.repeat(70));

// Read certifications config to build channel-to-cert mapping
const configPath = 'client/src/lib/certifications-config.ts';
const configContent = fs.readFileSync(configPath, 'utf-8');

// Extract certification mappings
const certMappings = {};
const certBlocks = configContent.matchAll(/\{[^}]*id:\s*'([^']+)'[^}]*channelMappings:\s*\[([^\]]+)\]/gs);

for (const match of certBlocks) {
  const certId = match[1];
  const mappingsText = match[2];
  
  // Extract channel IDs from mappings
  const channelMatches = mappingsText.matchAll(/channelId:\s*'([^']+)'/g);
  for (const channelMatch of channelMatches) {
    const channelId = channelMatch[1];
    if (!certMappings[channelId]) {
      certMappings[channelId] = [];
    }
    certMappings[channelId].push(certId);
  }
}

console.log('\nüìä Channel to Certification Mappings:');
Object.entries(certMappings).sort().forEach(([channel, certs]) => {
  console.log(`   ${channel}: ${certs.join(', ')}`);
});

// Create the enhanced question generation wrapper
const enhancedGeneratorCode = `/**
 * Enhanced Question Generator with Certification Awareness
 * 
 * Automatically generated by enhance-question-generation-with-certs.js
 * DO NOT EDIT MANUALLY - regenerate using the script
 */

import { generateQuestion as originalGenerateQuestion } from './ai/graphs/question-graph.js';
import { generateCertificationQuestions } from './ai/graphs/certification-question-graph.js';
import { certificationDomains } from './ai/prompts/templates/certification-question.js';

// Channel to Certification mappings (auto-generated)
const CHANNEL_TO_CERTS = ${JSON.stringify(certMappings, null, 2)};

/**
 * Enhanced question generator that considers certifications
 * 
 * When generating questions for a channel, it will:
 * 1. Generate regular interview questions (existing logic)
 * 2. Check if channel maps to any certifications
 * 3. Optionally generate certification MCQ questions
 * 
 * @param {Object} options - Generation options
 * @param {string} options.channel - Channel ID
 * @param {string} options.subChannel - Sub-channel ID
 * @param {string} options.difficulty - Question difficulty
 * @param {boolean} options.includeCertifications - Whether to generate cert questions (default: true)
 * @param {number} options.certQuestionsPerCert - Number of cert questions per certification (default: 1)
 * @returns {Object} Generation result with both regular and cert questions
 */
export async function generateQuestionWithCertifications(options) {
  const {
    channel,
    subChannel,
    difficulty = 'intermediate',
    includeCertifications = true,
    certQuestionsPerCert = 1,
    ...otherOptions
  } = options;
  
  console.log(\`\\nüéØ Enhanced Question Generation for: \${channel}\`);
  
  // Step 1: Generate regular interview question
  console.log(\`   üìù Generating regular interview question...\`);
  const regularResult = await originalGenerateQuestion({
    channel,
    subChannel,
    difficulty,
    ...otherOptions
  });
  
  const results = {
    regular: regularResult,
    certifications: []
  };
  
  // Step 2: Check for certification mappings
  if (!includeCertifications) {
    console.log(\`   ‚è≠Ô∏è  Skipping certification questions (includeCertifications=false)\`);
    return results;
  }
  
  const relatedCerts = CHANNEL_TO_CERTS[channel] || [];
  
  if (relatedCerts.length === 0) {
    console.log(\`   ‚ÑπÔ∏è  No certifications mapped to channel: \${channel}\`);
    return results;
  }
  
  console.log(\`   üéì Found \${relatedCerts.length} related certifications: \${relatedCerts.join(', ')}\`);
  
  // Step 3: Generate certification questions for each related cert
  for (const certId of relatedCerts) {
    // Check if this cert has domains configured
    if (!certificationDomains[certId]) {
      console.log(\`   ‚ö†Ô∏è  No domains configured for \${certId}, skipping\`);
      continue;
    }
    
    try {
      console.log(\`   üìã Generating \${certQuestionsPerCert} MCQ for \${certId}...\`);
      
      const certResult = await generateCertificationQuestions({
        certificationId: certId,
        difficulty,
        count: certQuestionsPerCert
      });
      
      if (certResult.success) {
        results.certifications.push({
          certId,
          result: certResult
        });
        console.log(\`   ‚úÖ Generated \${certResult.questions?.length || 0} cert questions for \${certId}\`);
      } else {
        console.log(\`   ‚ö†Ô∏è  Failed to generate cert questions for \${certId}: \${certResult.error}\`);
      }
    } catch (error) {
      console.log(\`   ‚ùå Error generating cert questions for \${certId}: \${error.message}\`);
    }
  }
  
  return results;
}

/**
 * Get certifications related to a channel
 */
export function getCertificationsForChannel(channel) {
  return CHANNEL_TO_CERTS[channel] || [];
}

/**
 * Get all channels that have certification mappings
 */
export function getChannelsWithCertifications() {
  return Object.keys(CHANNEL_TO_CERTS);
}

/**
 * Check if a channel has related certifications
 */
export function hasRelatedCertifications(channel) {
  return (CHANNEL_TO_CERTS[channel] || []).length > 0;
}

export default {
  generateQuestionWithCertifications,
  getCertificationsForChannel,
  getChannelsWithCertifications,
  hasRelatedCertifications,
  CHANNEL_TO_CERTS
};
`;

// Write the enhanced generator
const outputPath = 'script/ai/graphs/enhanced-question-generator.js';
fs.writeFileSync(outputPath, enhancedGeneratorCode);

console.log(`\n‚úÖ Created: ${outputPath}`);

// Create usage example
const exampleCode = `/**
 * Example: Using Enhanced Question Generator
 */

import { generateQuestionWithCertifications } from './ai/graphs/enhanced-question-generator.js';

// Example 1: Generate question for AWS channel (will include AWS cert questions)
const result1 = await generateQuestionWithCertifications({
  channel: 'aws',
  subChannel: 'ec2',
  difficulty: 'intermediate',
  includeCertifications: true,  // default
  certQuestionsPerCert: 2       // generate 2 MCQs per related cert
});

console.log('Regular question:', result1.regular);
console.log('Certification questions:', result1.certifications);

// Example 2: Generate only regular question (skip certs)
const result2 = await generateQuestionWithCertifications({
  channel: 'aws',
  difficulty: 'advanced',
  includeCertifications: false  // skip cert questions
});

// Example 3: Generate for Kubernetes (will include CKA, CKAD, CKS)
const result3 = await generateQuestionWithCertifications({
  channel: 'kubernetes',
  difficulty: 'intermediate'
});
`;

const examplePath = 'script/examples/enhanced-question-generation-example.js';
fs.mkdirSync(path.dirname(examplePath), { recursive: true });
fs.writeFileSync(examplePath, exampleCode);

console.log(`‚úÖ Created: ${examplePath}`);

// Create integration guide
const integrationGuide = `# Enhanced Question Generation with Certification Awareness

## Overview

The question generation system now automatically considers certifications when generating questions for channels.

## How It Works

When you generate a question for a channel (e.g., 'aws', 'kubernetes'), the system:

1. ‚úÖ Generates a regular interview question (existing logic)
2. ‚úÖ Checks if the channel maps to any certifications
3. ‚úÖ Optionally generates certification MCQ questions for related certs

## Channel to Certification Mappings

${Object.entries(certMappings).sort().map(([channel, certs]) => 
  `- **${channel}**: ${certs.join(', ')}`
).join('\n')}

## Usage

### Basic Usage (with certifications)

\`\`\`javascript
import { generateQuestionWithCertifications } from './ai/graphs/enhanced-question-generator.js';

const result = await generateQuestionWithCertifications({
  channel: 'aws',
  difficulty: 'intermediate'
});

// Result contains:
// - result.regular: Regular interview question
// - result.certifications: Array of cert questions for related certs
\`\`\`

### Skip Certification Questions

\`\`\`javascript
const result = await generateQuestionWithCertifications({
  channel: 'aws',
  difficulty: 'intermediate',
  includeCertifications: false  // Skip cert questions
});
\`\`\`

### Control Number of Cert Questions

\`\`\`javascript
const result = await generateQuestionWithCertifications({
  channel: 'kubernetes',
  difficulty: 'advanced',
  certQuestionsPerCert: 3  // Generate 3 MCQs per related cert
});
\`\`\`

## Integration with Existing Code

### Option 1: Replace Existing Calls

Replace:
\`\`\`javascript
import { generateQuestion } from './ai/graphs/question-graph.js';
const result = await generateQuestion({ channel: 'aws', difficulty: 'intermediate' });
\`\`\`

With:
\`\`\`javascript
import { generateQuestionWithCertifications } from './ai/graphs/enhanced-question-generator.js';
const result = await generateQuestionWithCertifications({ 
  channel: 'aws', 
  difficulty: 'intermediate' 
});
\`\`\`

### Option 2: Use Alongside Existing

Keep existing code and add certification generation:
\`\`\`javascript
import { generateQuestion } from './ai/graphs/question-graph.js';
import { getCertificationsForChannel } from './ai/graphs/enhanced-question-generator.js';
import { generateCertificationQuestions } from './ai/graphs/certification-question-graph.js';

// Generate regular question
const regularQ = await generateQuestion({ channel: 'aws' });

// Check for related certs
const certs = getCertificationsForChannel('aws');
if (certs.length > 0) {
  // Generate cert questions
  for (const certId of certs) {
    const certQ = await generateCertificationQuestions({ certificationId: certId });
  }
}
\`\`\`

## Helper Functions

### getCertificationsForChannel(channel)
Returns array of certification IDs related to a channel.

\`\`\`javascript
import { getCertificationsForChannel } from './ai/graphs/enhanced-question-generator.js';

const certs = getCertificationsForChannel('aws');
// Returns: ['aws-saa', 'aws-sap', 'aws-dva', 'aws-sysops', ...]
\`\`\`

### hasRelatedCertifications(channel)
Check if a channel has related certifications.

\`\`\`javascript
import { hasRelatedCertifications } from './ai/graphs/enhanced-question-generator.js';

if (hasRelatedCertifications('aws')) {
  console.log('AWS channel has related certifications');
}
\`\`\`

### getChannelsWithCertifications()
Get all channels that have certification mappings.

\`\`\`javascript
import { getChannelsWithCertifications } from './ai/graphs/enhanced-question-generator.js';

const channels = getChannelsWithCertifications();
// Returns: ['aws', 'kubernetes', 'system-design', 'networking', ...]
\`\`\`

## Benefits

1. **Automatic Coverage**: Certification questions are generated automatically when working with related channels
2. **Balanced Content**: Ensures both interview questions and certification prep content
3. **Flexible**: Can enable/disable certification generation per call
4. **Discoverable**: Helper functions make it easy to see channel-cert relationships

## Files Created

- \`script/ai/graphs/enhanced-question-generator.js\` - Main enhanced generator
- \`script/examples/enhanced-question-generation-example.js\` - Usage examples
- \`docs/ENHANCED_QUESTION_GENERATION.md\` - This guide

## Regenerating

If certifications config changes, regenerate the enhanced generator:

\`\`\`bash
node script/enhance-question-generation-with-certs.js
\`\`\`

This will update the channel-to-cert mappings automatically.
`;

const guidePath = 'docs/ENHANCED_QUESTION_GENERATION.md';
fs.writeFileSync(guidePath, integrationGuide);

console.log(`‚úÖ Created: ${guidePath}`);

console.log('\n' + '‚ïê'.repeat(70));
console.log('‚úÖ Enhancement Complete!');
console.log('‚ïê'.repeat(70));
console.log('\nFiles created:');
console.log(`  1. ${outputPath}`);
console.log(`  2. ${examplePath}`);
console.log(`  3. ${guidePath}`);
console.log('\nNext steps:');
console.log('  1. Review the generated files');
console.log('  2. Update your question generation code to use the enhanced generator');
console.log('  3. Test with: node script/examples/enhanced-question-generation-example.js');
console.log('‚ïê'.repeat(70));
